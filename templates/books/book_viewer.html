{% extends "base/base.html" %}

{% block title %}Viewing: {{ book.title }}{% endblock %}

{% block extra_css %}
<style>
    /* make viewer fill horizontal space */
    #viewer-container {
        width: 100%;
        height: 90vh;
        position: relative;
    }

    /* disable selection */
    #viewer-container,
    #viewer-container * {
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
    }

    /* EPUB Viewer Navigation Buttons */
    #viewer-controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 15px;
    }

    .epub-btn {
        background-color: var(--secondary-color);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.2s;
    }

    .epub-btn:hover {
        background-color: var(--accent-color);
    }

    .epub-btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<h2>{{ book.title }}</h2>
<p class="text-muted">by {{ book.author.get_full_name }}</p>
<div id="viewer-container">
    <!-- the PDF/EPUB will be rendered here -->
</div>
{% if mime and 'epub' in mime %}
<div id="viewer-controls">
    <button id="prev-btn" class="epub-btn"><i class="bi bi-chevron-left"></i> Previous</button>
    <button id="next-btn" class="epub-btn">Next <i class="bi bi-chevron-right"></i></button>
</div>
{% endif %}
<p class="mt-3 text-secondary small">This document is view-only. Download and screenshot features are disabled by
    policy.</p>
{% endblock %}

{% block extra_js %}
{% if mime and 'epub' in mime %}
<!-- epub.js for EPUB files -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/epub.js/0.3.88/epub.min.js"></script>
<script>
    (() => {
        const url = "{% url 'book_file' book.pk %}";
        const viewer = document.getElementById('viewer-container');
        viewer.addEventListener('contextmenu', e => e.preventDefault());

        const bookObj = ePub(url);
        const rendition = bookObj.renderTo(viewer, { width: '100%', height: '100%' });
        rendition.display();

        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');

        // Button event listeners
        if (prevBtn) {
            prevBtn.addEventListener('click', () => rendition.prev());
        }
        if (nextBtn) {
            nextBtn.addEventListener('click', () => rendition.next());
        }

        // simple navigation with arrow keys
        document.addEventListener('keydown', e => {
            if (e.key === 'ArrowRight') rendition.next();
            if (e.key === 'ArrowLeft') rendition.prev();
        });
    })();
</script>
{% else %}
<!-- pdf.js from CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.107/pdf.min.js"></script>
<script>
    (() => {
        const url = "{% url 'book_file' book.pk %}";
        const viewer = document.getElementById('viewer-container');
        viewer.addEventListener('contextmenu', e => e.preventDefault());

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.107/pdf.worker.min.js';

        fetch(url)
            .then(r => r.arrayBuffer())
            .then(data => {
                pdfjsLib.getDocument({ data }).promise.then(pdf => {
                    for (let i = 1; i <= pdf.numPages; i++) {
                        pdf.getPage(i).then(page => {
                            const scale = 1.5;
                            const viewport = page.getViewport({ scale });
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;
                            viewer.appendChild(canvas);
                            page.render({ canvasContext: ctx, viewport: viewport });
                        });
                    }
                });
            });
    })();
</script>
{% endif %}
{% endblock %}