{% extends "base/base.html" %}

{% block title %}Role Change Requests - BookShare{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1><i class="bi bi-arrow-left-right"></i> Role Change Requests</h1>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-hover">
        <thead class="table-light">
            <tr>
                <th>User</th>
                <th>Current Role</th>
                <th>Requested Role</th>
                <th>Requested</th>
                <th>Reason</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for role_req in role_requests %}
                <tr>
                    <td><strong>{{ role_req.user.get_full_name }}</strong><br><small>@{{ role_req.user.username }}</small></td>
                    <td><span class="badge badge-secondary">{{ role_req.user.get_role_display }}</span></td>
                    <td><span class="badge badge-info">{{ role_req.get_requested_role_display }}</span></td>
                    <td>{{ role_req.created_at|date:"M d, Y H:i" }}</td>
                    <td>{{ role_req.reason|truncatewords:10 }}</td>
                    <td>
                        <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#details{{ role_req.pk }}">View</button>
                        <form method="post" style="display: inline-block;">
                            {% csrf_token %}
                            <input type="hidden" name="request_id" value="{{ role_req.pk }}">
                            <input type="hidden" name="action" value="approve">
                            <button type="submit" class="btn btn-sm btn-success">Approve</button>
                        </form>
                        <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#reject{{ role_req.pk }}">Reject</button>
                    </td>
                </tr>

                <!-- Details Modal -->
                <div class="modal fade" id="details{{ role_req.pk }}" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Role Change Request</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p><strong>User:</strong> {{ role_req.user.get_full_name }} (@{{ role_req.user.username }})</p>
                                <p><strong>Current Role:</strong> {{ role_req.user.get_role_display }}</p>
                                <p><strong>Requested Role:</strong> {{ role_req.get_requested_role_display }}</p>
                                <p><strong>Reason:</strong></p>
                                <p>{{ role_req.reason }}</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reject Modal -->
                <div class="modal fade" id="reject{{ role_req.pk }}" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form method="post">
                                {% csrf_token %}
                                <div class="modal-header">
                                    <h5 class="modal-title">Reject Request</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="reason{{ role_req.pk }}" class="form-label">Reason</label>
                                        <textarea class="form-control" id="reason{{ role_req.pk }}" name="reason" rows="4"></textarea>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <input type="hidden" name="request_id" value="{{ role_req.pk }}">
                                    <input type="hidden" name="action" value="reject">
                                    <button type="submit" class="btn btn-danger">Reject</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            {% empty %}
                <tr>
                    <td colspan="6" class="text-center text-muted">No pending role change requests.</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
